---
title: "PC Optimization Report"
author: "sceQTL-flow"
date: "`r Sys.Date()`"
format: 
  html:
    code-fold: true
    toc: true
    toc-depth: 3
    fig-width: 10
    fig-height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(data.table)
library(ggplot2)
library(gridExtra)

# Set theme
theme_set(theme_minimal() + theme(plot.title = element_text(hjust = 0.5, face = "bold")))

# Parameters (can be passed from R environment)
outdir <- Sys.getenv("OUTDIR", default = ".")
opt_dir <- file.path(outdir, "optimization")
```

# PC Optimization Strategy

This report details the two-stage PC optimization process used in the eQTL pipeline.

## Overview

The pipeline employs a **coarse-to-fine grid search** with **early stopping** and **elbow tolerance** to select the optimal number of principal components (PCs) for each cell type:

1. **Coarse Stage**: Test PCs in steps of 10 (2, 12, 22, ...) up to 50% of sample size
2. **Early Stopping**: Halt coarse evaluation when 2 consecutive steps show <1% improvement
3. **Fine Stage**: Refine search around the best coarse PC (±10 in steps of 2)
4. **Elbow Selection**: Pick the smallest PC count within 2% of maximum associations

---

## Coarse Grid Optimization

```{r coarse-load}
# Load all coarse summary files
coarse_files <- list.files(opt_dir, pattern = "_coarse_summary.csv$", full.names = TRUE)

if (length(coarse_files) == 0) {
  cat("No coarse optimization results found.\n")
  coarse_data <- NULL
} else {
  coarse_data <- map_df(coarse_files, ~{
    celltype <- gsub("_coarse_summary.csv", "", basename(.x))
    fread(.x) %>% mutate(celltype = celltype)
  }, .id = "file") %>%
    select(-file) %>%
    as_tibble()
}
```

### Coarse Results by Cell Type

```{r coarse-table}
if (!is.null(coarse_data)) {
  coarse_data %>%
    select(celltype, n_pcs, n_assoc, gain_pct, below_threshold, is_ceiling, is_best) %>%
    mutate(
      gain_pct = round(gain_pct, 2),
      n_pcs_label = paste0(n_pcs, if_else(is_ceiling, " ⬅️ CEILING", ""), 
                           if_else(is_best, " ⭐ BEST", ""))
    ) %>%
    select(-is_ceiling, -is_best) %>%
    knitr::kable(
      caption = "Coarse Grid Results: All PC counts tested with gains and early-stop indicators",
      col.names = c("Cell Type", "n_PCs", "n_Associations", "Gain (%)", "Below 1% Tol?", "n_PCs Label")
    )
} else {
  cat("No coarse data available.\n")
}
```

### Coarse Gains Visualization

```{r coarse-plot, fig.cap="Coarse grid gains: Shows % improvement in associations as PCs increase. Red line = early-stop threshold (1%). Red dashed line = ceiling PC (where 2 consecutive gains <1%)."}
if (!is.null(coarse_data)) {
  p_list <- coarse_data %>%
    group_by(celltype) %>%
    group_map(~{
      .x %>%
        arrange(n_pcs) %>%
        ggplot(aes(x = n_pcs, y = gain_pct, color = below_threshold)) +
        geom_line(color = "gray60", size = 0.8) +
        geom_point(size = 3, aes(color = below_threshold)) +
        geom_hline(yintercept = 1, linetype = "dashed", color = "red", size = 1, alpha = 0.5) +
        geom_vline(data = filter(.x, is_ceiling), aes(xintercept = n_pcs), 
                   linetype = "dashed", color = "darkred", size = 1, alpha = 0.5) +
        scale_color_manual(values = c("FALSE" = "steelblue", "TRUE" = "orange"),
                          name = "Below 1%?") +
        labs(
          title = paste0("Cell Type: ", unique(.x$celltype)),
          x = "Number of PCs",
          y = "Gain (%)",
          subtitle = "Red horizontal = threshold (1%), Red vertical = ceiling (early-stop)"
        ) +
        theme(legend.position = "bottom")
    })
  
  if (length(p_list) > 0) {
    do.call(gridExtra::grid.arrange, c(p_list, ncol = 2))
  }
} else {
  cat("No coarse data for visualization.\n")
}
```

---

## Fine Grid Optimization

```{r fine-load}
# Load all fine summary files
fine_files <- list.files(opt_dir, pattern = "_fine_summary.csv$", full.names = TRUE)

if (length(fine_files) == 0) {
  cat("No fine optimization results found.\n")
  fine_data <- NULL
} else {
  fine_data <- map_df(fine_files, ~{
    celltype <- gsub("_fine_summary.csv", "", basename(.x))
    fread(.x) %>% mutate(celltype = celltype)
  }, .id = "file") %>%
    select(-file) %>%
    as_tibble()
}
```

### Fine Results by Cell Type

```{r fine-table}
if (!is.null(fine_data)) {
  fine_data %>%
    select(celltype, n_pcs, n_assoc, threshold, within_elbow, is_selected) %>%
    mutate(
      threshold = round(threshold, 0),
      n_pcs_label = if_else(is_selected, paste0(n_pcs, " ⭐ SELECTED"), as.character(n_pcs))
    ) %>%
    select(-is_selected) %>%
    knitr::kable(
      caption = "Fine Grid Results: PC counts within the refined window with elbow tolerance applied",
      col.names = c("Cell Type", "n_PCs", "n_Associations", "Elbow Threshold", "Within Elbow?", "Label")
    )
} else {
  cat("No fine data available.\n")
}
```

### Fine Grid Visualization with Elbow Rule

```{r fine-plot, fig.cap="Fine grid results: Blue dots = tested PCs, green dot = selected PC (smallest within 2% of maximum), light blue band = elbow tolerance region."}
if (!is.null(fine_data)) {
  p_list <- fine_data %>%
    group_by(celltype) %>%
    group_map(~{
      max_assoc <- max(.x$n_assoc, na.rm = TRUE)
      threshold <- unique(.x$threshold)[1]
      selected_pc <- .x %>% filter(is_selected) %>% pull(n_pcs) %>% first()
      
      .x %>%
        arrange(n_pcs) %>%
        ggplot(aes(x = n_pcs, y = n_assoc)) +
        # Elbow region (light blue band)
        geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = threshold, ymax = max_assoc),
                 fill = "lightblue", alpha = 0.3, inherit.aes = FALSE) +
        # Line through points
        geom_line(color = "gray60", size = 0.8) +
        # All points
        geom_point(size = 3, color = "steelblue") +
        # Selected point in green
        geom_point(data = filter(.x, is_selected), size = 5, color = "darkgreen", shape = 17) +
        # Max line
        geom_hline(yintercept = max_assoc, linetype = "dashed", color = "red", alpha = 0.5) +
        labs(
          title = paste0("Cell Type: ", unique(.x$celltype)),
          x = "Number of PCs",
          y = "Number of Significant Associations (FDR<0.05)",
          subtitle = paste0("Selected n_PCs = ", selected_pc, " (smallest within 2% of max)")
        )
    })
  
  if (length(p_list) > 0) {
    do.call(gridExtra::grid.arrange, c(p_list, ncol = 2))
  }
} else {
  cat("No fine data for visualization.\n")
}
```

---

## Summary: Selected PC Counts

```{r summary-table}
if (!is.null(fine_data)) {
  selected_pcs <- fine_data %>%
    filter(is_selected) %>%
    select(celltype, n_pcs, n_assoc) %>%
    rename(`Cell Type` = celltype, `Selected n_PCs` = n_pcs, `n_Associations at Selection` = n_assoc) %>%
    arrange(`Cell Type`)
  
  knitr::kable(
    selected_pcs,
    caption = "Final Selected PC Counts for Each Cell Type"
  )
} else {
  cat("No selection data available.\n")
}
```

---

## Parameters Used

```{r params-table}
params_summary <- tibble(
  Parameter = c("Coarse Step", "Fine Step", "Fine Window", "Early Stop Tolerance", "Early Stop Patience", "Elbow Tolerance"),
  Value = c("10", "2", "±10", "1%", "2 consecutive steps", "2%"),
  Description = c(
    "PC increment for coarse grid",
    "PC increment for fine grid",
    "Range around best coarse PC",
    "Threshold for low gain detection",
    "Consecutive low-gain steps to trigger stop",
    "Allow up to 2% below maximum associations"
  )
)

knitr::kable(params_summary, caption = "PC Optimization Parameters")
```

---

## Interpretation Guide

### Coarse Stage
- **Early Stopping**: If 2 consecutive steps show <1% improvement in associations, coarse evaluation halts
- **Ceiling**: The last PC value before early stopping triggers
- **Best Coarse PC**: The PC with maximum associations **up to the ceiling**

### Fine Stage
- **Elbow Tolerance**: Region within 2% of the maximum associations
- **Selected PC**: The smallest PC count in the elbow region (balances accuracy with parsimony)
- **Interpretation**: This selection avoids overfitting (too many PCs) while capturing nearly-optimal eQTL power

### Example
If coarse shows gains of 10%, 4%, 0.8%, 0.2%:
- Early stop triggers at PC showing 0.2% (2 consecutive <1%)
- Ceiling = PC at 0.2%
- Best coarse = PC with highest associations before ceiling
- Fine grid = ±10 around best coarse
- Final = smallest PC in fine grid within 2% of max

